# 要件・設計管理

## 基本情報

| 項目 | 値 |
|------|-----|
| プロジェクト名 | Sales MS（リース販売管理システム） |
| バージョン | ver04 |
| 作成日 | 2025/12/19 |
| 最終更新日 | 2025/12/22 |

---

## 契約フェーズ・ステータス一覧

### ステータス遷移表

| 順序 | 大分類 | 小分類 | 状態概要 | 補足 | 必要なアクション |
|------|--------|--------|----------|------|------------------|
| 1 | 商談中 | 商談待ち | 商談日程が確定している（初期ステータス） | | 商談を実施する |
| 2 | 商談中 | 商談日程調整中 | 商談日程の調整が必要。リスケ依頼がきた場合や、担当者が不在だった場合 | 顧客から日程変更依頼があった、または訪問時に担当者が不在だった状態 | 顧客と日程を調整し確定させる |
| 3 | 審査・申込中 | 審査・申込対応中 | 審査または申込に必要な書類等を準備している | 【物件】リース審査用の書類を準備中。【回線】NTTへの申込準備中。請求書の名義と契約名義の相違確認が必要。住所・電話番号・契約名義が全て一致している必要があり、1つでもズレていると不一致で返却される。請求書は会社名義だが契約名義が異なるケースや、顧客自身が正確な情報を把握していないケースが多い。電話会社が17時閉まるため、17時以降の商談では請求書での判断しかできない | 必要書類を揃えて提出する |
| 4 | 審査・申込中 | 審査・申込待ち | 審査または申込を提出し結果を待っている | 【物件】リース会社の審査結果待ち。【回線】NTTからの申込結果待ち。名義・住所不一致の場合は連絡があり、再対応が必要 | 結果連絡を待つ |
| 5 | 下見・工事中 | 下見調整中 | 審査・申込が完了した | | 下見の日程を顧客と調整する |
| 6 | 下見・工事中 | 下見実施待ち | 下見日程が確定している | | 下見を実施する |
| 7 | 下見・工事中 | 工事日程調整中 | 下見が完了した | すぐ工事日が決まれば問題ないが、現場調査の結果、新規配管が必要など追加対応が発生することがある。その場合、管理会社への連絡や工事業者との再調整が必要になる | 工事の日程を顧客・業者と調整する |
| 8 | 下見・工事中 | 工事実施待ち | 工事日程が確定している | | 工事を実施する |
| 9 | 契約中 | 検収確認中 | 工事が完了した | 工事完了後、リース会社から顧客への検収電話と契約書回収を行う状態。検収電話では「月額いくらで何年間支払い」の確認を行い、顧客が「聞いていない」となると契約締結にならない。代表者不在で日程がずれることもある。契約締結＝契約書回収＋検収電話対応完了。これが完了しないと入金に進まないため重要 | 契約書の回収、検収電話の対応を行う |
| 10 | 契約中 | 契約書提出対応中 | 契約書の回収が完了＋顧客の検収電話対応が完了 | 契約書をリース会社へ提出する準備をする状態。契約書の記入漏れや押印漏れがあると、リース会社から差し戻しの連絡があり再取得が発生する | 契約書をリース会社へ提出する |
| 11 | 契約中 | 契約書確認待ち | 契約書をリース会社へ提出済み | リース会社で契約書の内容確認中。不備があれば連絡があり、再対応が必要 | リース会社の契約書確認を待つ |
| 12 | 入金中 | 入金待ち | リース会社の契約書確認が完了した | | リース会社からの入金を待つ |
| 13 | 入金中 | 入金済 | 入金が確認された | | 請求フェーズへ進む |
| 14 | 請求中 | 初回請求確認待ち | リース会社から顧客への初回請求処理中 | リース会社から顧客への口座引き落としが正常に行われるか確認待ちの状態。口座情報の不備（銀行/信用金庫の選択ミス、届出印相違、印影不鮮明など）があると引き落とし会社から差し戻される | リース会社からの請求結果を待つ |
| 15 | 請求中 | 請求処理対応中 | 初回請求で問題が発生した | 顧客に連絡し、正しい口座情報の再取得が必要 | 顧客に連絡し、口座情報を再取得する |
| 16 | 完了 | クローズ | 案件が完了した | | なし |
| - | 否決 | 対応検討中 | 審査または申込が通らなかった | リース審査否決、またはNTT名義・住所不一致で申込が通らなかった状態。別のリース会社での再審査、顧客への再確認などを検討する | 再審査・再申込を検討する |
| - | 否決 | 失注 | 契約が成立しなかった | 再審査・再申込も不可となり、契約成立に至らなかった状態 | なし |

### 商材一覧

| 契約種類 | 商材選択肢 |
|----------|------------|
| 物件 | UTM / ルーター / 複合機 / その他 |
| 回線 | インターネット / 電話 / その他 |
| 保守 | インターネット / 電話 / その他 |

### 契約種類ごとの審査・申込内容

| 契約種類 | 審査・申込の内容 |
|----------|------------------|
| 物件 | リース審査 |
| 回線 | NTT名義・住所確認 |
| 保守 | 保守契約申込 |

---

## 業務要件・システム要件・設計

| No | 業務：大分類 | 大分類ID | 業務：中分類 | 中分類ID | 業務 | 業務ID | 詳細 | SRID | 概要 | 詳細 | 決定理由 | 概要 | 詳細 | 決定理由 | 関連ファイル | 優先度 | ステータス | 却下理由 | 課題No | 起票日 |
|----|-------------|----------|-------------|----------|------|--------|------|------|------|------|----------|------|------|----------|--------------|--------|-----------|----------|--------|--------|
| 1 | デプロイメント管理 | BIZ-001 | Git運用 | BIZ-001-01 | ブランチマージ | BIZ-001-01-01 | version1ブランチの変更をmainブランチにマージし、本番環境に反映する | SYS-001-01-01-01 | Gitブランチマージ | 1. git fetchでリモートの最新情報を取得する<br>2. ローカル変更を破棄または退避する<br>3. git mergeでブランチをマージする<br>4. git pushでリモートに反映する | 1. ローカルとリモートの差分を正確に把握するため<br>2. マージコンフリクトを回避するため<br>3. Fast-forwardマージでコミット履歴を保つため<br>4. リモートリポジトリを最新状態にするため | Git CLIによるマージ操作 | 1. `git fetch origin` - リモート最新取得<br>2. `git checkout -- . && git clean -fd` - ローカル変更破棄<br>3. `git merge origin/claude/version-1-initial-setup-o44OO` - マージ実行<br>4. `git push origin main` - リモートへプッシュ | 1. リモートブランチの確認は必ずfetch後に行う（ローカルキャッシュは古い可能性がある）<br>2. Fast-forwardマージはWebhookをトリガーしない場合がある<br>3. ローカル変更の破棄は--forceではなくcheckout --とcleanを使用 | - | 高 | 完了 | - | - | 2025/12/19 |
| 2 | デプロイメント管理 | BIZ-001 | Vercel運用 | BIZ-001-02 | 自動デプロイ | BIZ-001-02-01 | GitHubへのpush時にVercelで自動的にデプロイが実行される | SYS-001-02-01-01 | Vercel自動デプロイ | 1. GitHubリポジトリとVercelプロジェクトを連携<br>2. pushイベントをWebhookでVercelに通知<br>3. Vercelがビルド・デプロイを実行 | 1. 継続的デプロイメント（CD）を実現するため<br>2. 手動デプロイの手間を削減するため<br>3. デプロイの一貫性を確保するため | GitHub + Vercel Git Integration | 1. Production Branch: main<br>2. Auto Deploy: 有効<br>3. Preview Deployments: 有効 | 1. GitHub WebhookとVercelの連携で自動化<br>2. プロダクションブランチはmainに設定<br>3. Fast-forwardマージではWebhookがトリガーされない場合がある | vercel.json（未作成） | 高 | 完了 | - | ISS-001 | 2025/12/19 |
| 3 | デプロイメント管理 | BIZ-001 | Vercel運用 | BIZ-001-02 | 手動デプロイ | BIZ-001-02-02 | 自動デプロイが動作しない場合、手動でデプロイを実行する | SYS-001-02-02-01 | Vercel CLIによる手動デプロイ | 1. Vercel CLIをインストール<br>2. プロジェクトをVercelにリンク<br>3. `vercel --prod`コマンドでデプロイ実行 | 1. 自動デプロイの障害時のバックアップ手段<br>2. 即時デプロイが必要な場合の対応<br>3. デプロイ状況の詳細確認が可能 | Vercel CLI | 1. `vercel --prod` - 本番デプロイ実行<br>2. `vercel ls` - デプロイ一覧確認<br>3. `vercel inspect [url]` - デプロイ詳細確認 | 1. CLIはnpm i -g vercelでインストール<br>2. --prodフラグで本番環境にデプロイ<br>3. デプロイURL・ステータス・ビルド時間を確認可能 | - | 中 | 完了 | - | - | 2025/12/19 |
| 4 | デプロイメント管理 | BIZ-001 | Vercel運用 | BIZ-001-02 | Git連携設定 | BIZ-001-02-03 | VercelプロジェクトのGit連携を正しいリポジトリに設定する | SYS-001-02-03-01 | Vercel Git連携設定 | 1. VercelダッシュボードでSettingsを開く<br>2. Git連携セクションで接続リポジトリを確認<br>3. 別リポジトリが設定されている場合は切り替える | 1. 誤ったリポジトリがデプロイされる問題を防ぐため<br>2. Git pushで正しいコードがデプロイされることを保証するため | Vercelダッシュボード設定 | 1. Settings → Git → Connected Git Repository<br>2. Disconnectで既存連携を解除<br>3. Connect Git Repositoryで正しいリポジトリを選択<br>4. chosenp31/SalesMSを選択 | 1. 複数プロジェクトが同名の場合に連携ミスが発生しやすい<br>2. CLIからのvercel linkでは既存設定を上書きしない | - | 高 | 完了 | - | ERR-001 | 2025/12/22 |
| 5 | デプロイメント管理 | BIZ-001 | GitHub運用 | BIZ-001-03 | デフォルトブランチ設定 | BIZ-001-03-01 | GitHubリポジトリのデフォルトブランチをmainに設定する | SYS-001-03-01-01 | GitHubデフォルトブランチ設定 | 1. GitHub APIを使用してデフォルトブランチを変更<br>2. gh api repos/{owner}/{repo} -X PATCH -f default_branch=main | 1. Vercelがデフォルトブランチを本番ブランチとして認識するため<br>2. PRのベースブランチがmainになるため | GitHub API / gh CLI | 1. `gh api repos/chosenp31/SalesMS -X PATCH -f default_branch=main`<br>2. Settings → Branches → Default branchでも変更可能 | 1. デフォルトブランチが異なるブランチ（claude/version-1-...）になっていると、Vercelが誤ったブランチをデプロイする可能性がある | - | 高 | 完了 | - | - | 2025/12/22 |
| 6 | ユーザー体験 | BIZ-002 | 検索・フィルタ | BIZ-002-01 | クイックフィルタ | BIZ-002-01-01 | よく使うフィルタを検索バー横にインライン表示し、即座にアクセス可能にする | SYS-002-01-01-01 | クイックフィルタ機能 | 1. FilterOptionにquickFilter:booleanプロパティ追加<br>2. quickFilter:trueのフィルタはインライン表示<br>3. その他は「その他」ボタンでPopover表示 | 1. フィルタへのアクセス時間短縮<br>2. Salesforce/HubSpotのベストプラクティスに準拠<br>3. 頻繁に使うフィルタを目立たせる | SearchFilterBarコンポーネント拡張 | 1. quickFiltersとadvancedFiltersを分離<br>2. インラインSelectコンポーネント<br>3. レスポンシブ対応（sm:block hidden） | 1. 一般的なCRMのUI設計に準拠<br>2. モバイルでは折りたたんでスペース節約 | src/components/ui/search-filter-bar.tsx | 高 | 完了 | - | - | 2025/12/19 |
| 7 | ユーザー体験 | BIZ-002 | 検索・フィルタ | BIZ-002-01 | 日付プリセット | BIZ-002-01-02 | 「今日」「今週」「今月」などの日付範囲をワンクリックで選択可能にする | SYS-002-01-02-01 | 日付プリセット機能 | 1. DATE_PRESETS配列を定義（今日/昨日/今週/今月/先月/過去7日/過去30日）<br>2. getRange関数で日付範囲を動的計算<br>3. FilterOptionにtype:"datePreset"を追加 | 1. 日付フィルタの操作効率向上<br>2. 手動入力ミスの防止<br>3. ユーザーの思考パターンに合致 | date-fns日付計算 | 1. startOfDay/endOfDay/startOfWeek等を使用<br>2. Popoverで選択肢を表示<br>3. 選択時にアクティブ状態を視覚的に表示 | 1. date-fnsは既存依存なので追加インストール不要<br>2. ja localeで週の開始を月曜に設定 | src/components/ui/search-filter-bar.tsx | 中 | 完了 | - | - | 2025/12/19 |
| 8 | ユーザー体験 | BIZ-002 | 検索・フィルタ | BIZ-002-01 | ソートインジケータ改善 | BIZ-002-01-03 | テーブルヘッダーのソート状態を視覚的に明確にし、ホバー時にソート可能を示す | SYS-002-01-03-01 | ソートUI改善 | 1. ソート中の列をprimary色で強調<br>2. 非ソート列はホバー時にアイコン表示<br>3. transition効果で滑らかな切り替え | 1. ソート可能な列を明確化<br>2. 現在のソート状態を一目で把握<br>3. インタラクティブ性の向上 | SortHeaderコンポーネント | 1. sortField === fieldでアクティブ判定<br>2. group/group-hoverでホバー効果<br>3. opacity transitionで滑らかに表示 | 1. Tailwind CSS group機能を活用<br>2. 既存のChevron Up/Downアイコンを流用 | src/components/features/*/list.tsx | 中 | 完了 | - | - | 2025/12/19 |
| 9 | ユーザー体験 | BIZ-002 | 検索・フィルタ | BIZ-002-01 | 検索結果件数表示 | BIZ-002-01-04 | フィルタ適用時に「結果件数 / 全件数」形式で表示し、フィルタ効果を明確化 | SYS-002-01-04-01 | 件数表示改善 | 1. resultCountとtotalCountを両方表示<br>2. 「5 / 150 件」形式<br>3. resultCount != totalCountの場合のみスラッシュ表示 | 1. フィルタの効果を即座に把握<br>2. 全データ量の認識<br>3. 空結果時の原因特定が容易 | SearchFilterBarコンポーネント | 1. totalCountプロパティを追加<br>2. 条件付きレンダリングでスラッシュ表示 | 1. シンプルな表示でUIを複雑にしない | src/components/ui/search-filter-bar.tsx | 低 | 完了 | - | - | 2025/12/19 |
| 10 | データ管理 | BIZ-003 | 登録機能 | BIZ-003-01 | 案件登録 | BIZ-003-01-01 | 新規案件を登録し、顧客・担当者・契約情報を紐づける | SYS-003-01-01-01 | 案件登録機能 | 1. 顧客選択（オートコンプリート）<br>2. 担当者選択<br>3. 契約種類選択（複数可）<br>4. 商材選択（契約種類ごと）<br>5. deals/contractsテーブルへINSERT | 1. 顧客情報は既存データから選択させ入力ミスを防ぐ<br>2. 契約種類と商材の紐づけでデータ整合性を確保<br>3. 1つの案件に複数の契約を紐づけ可能とする | DealFormコンポーネント | 1. customer_id: 顧客UUID（必須）<br>2. assigned_user_id: 担当者UUID（必須）<br>3. contractSelections: [{type, products[]}]<br>4. 案件タイトルは顧客名+契約種類で自動生成 | 1. 顧客・担当者はUUIDで外部キー制約<br>2. デモモード時は認証なしでも最初のユーザーIDをフォールバック使用 | src/components/features/deals/deal-form.tsx<br>src/app/(dashboard)/deals/new/page.tsx | 高 | 完了 | - | ERR-002, ERR-003 | 2025/12/22 |
| 11 | データ管理 | BIZ-003 | 登録機能 | BIZ-003-01 | タスク登録 | BIZ-003-01-02 | 契約に紐づくタスクを登録する | SYS-003-01-02-01 | タスク登録機能 | 1. 契約詳細画面からタスク追加ダイアログを開く<br>2. タスク名・担当者・期限・優先度・ステータスを入力<br>3. tasksテーブルへINSERT | 1. タスクは契約に紐づけることで進捗管理を容易にする<br>2. 契約詳細画面からの導線でコンテキストを保持 | ContractTaskCardコンポーネント | 1. title: タスク名（必須）<br>2. assigned_user_id: 担当者UUID（必須）<br>3. contract_id: 契約UUID（自動設定）<br>4. deal_id: 案件UUID（契約から取得）<br>5. due_date, status, priority | 1. 契約詳細から作成することでcontract_id/deal_idを自動設定<br>2. tasksテーブルにはphase/contract_statusカラムが存在しないため挿入しない | src/components/features/contracts/contract-task-card.tsx | 高 | 完了 | - | ERR-004 | 2025/12/22 |
| 12 | データ管理 | BIZ-003 | 認証・権限 | BIZ-003-02 | デモモード対応 | BIZ-003-02-01 | 認証を無効化してデモ用にシステムを動作させる | SYS-003-02-01-01 | デモモード認証バイパス | 1. Supabase RLSを全許可ポリシーに設定<br>2. authUser?.idが空の場合はusers[0]?.idをフォールバック<br>3. 各登録フォームでdefaultUserIdを設定 | 1. デモ・検証環境で認証なしに動作確認するため<br>2. 外部キー制約違反を回避するため | RLSポリシー + フォールバックロジック | 1. 全テーブルにALLOW ALLポリシーを設定<br>2. pages/components側でcurrentUserIdのフォールバック実装<br>3. effectiveUserId = authUser?.id \|\| users[0]?.id \|\| "" | 1. 本番環境では認証必須に戻す必要がある<br>2. RLSは全テーブル一括で設定 | scripts/add-status-history-table.sql<br>src/app/(dashboard)/*/page.tsx | 高 | 完了 | - | ERR-002 | 2025/12/22 |

---

## 課題管理

| 課題No | 関連SRID | タイトル | 詳細 | 優先度 | ステータス | 対応策 | 起票日 |
|--------|----------|----------|------|--------|-----------|--------|--------|
| ISS-001 | SYS-001-02-01-01 | Fast-forwardマージ時の自動デプロイ未トリガー | GitHubへのpush（Fast-forwardマージ）時にVercelの自動デプロイがトリガーされなかった。原因として、既存コミットがmainに移動しただけで新規コミットが作成されなかったため、Webhookが「既に見たコミット」として認識しスキップした可能性がある。 | 高 | 解決済 | Vercel Git連携を正しいリポジトリ（chosenp31/SalesMS）に再設定。デフォルトブランチをmainに変更。 | 2025/12/19 |
| ISS-002 | SYS-001-02-03-01 | Vercel Git連携が別リポジトリを参照 | sales-msプロジェクトのGit連携が「物件マッチングツール」リポジトリを参照していたため、GitHubへpushすると誤ったアプリがデプロイされた。 | 高 | 解決済 | VercelダッシュボードでGit連携を解除し、chosenp31/SalesMSに再接続。デフォルトブランチをmainに設定。 | 2025/12/22 |

---

## 作業履歴（2025/12/22）

### 作業1: Vercel Git連携問題の解決

1. **問題の発見**
   - https://sales-ms.vercel.app にアクセスすると「物件マッチングツール」が表示される
   - GitHubへのpush後に誤ったアプリケーションがデプロイされていた

2. **原因調査**
   - VercelのGit連携が別リポジトリ（物件マッチングツール）を参照していた
   - GitHubのデフォルトブランチが`claude/version-1-initial-setup-o44OO`になっていた

3. **対応**
   - `vercel --prod`で直接デプロイし、正しいSales MSを表示
   - `gh api repos/chosenp31/SalesMS -X PATCH -f default_branch=main`でデフォルトブランチを変更
   - ユーザーにVercelダッシュボードでのGit連携変更手順を案内

### 作業2: 登録機能エラーの修正

1. **タスク登録エラー（ERR-004）**
   - 問題: `contract-task-card.tsx`で`phase`と`contract_status`カラムをINSERTしようとしてエラー
   - 原因: `tasks`テーブルにこれらのカラムが存在しない
   - 対応: `taskData`から不要なカラムを削除

2. **案件登録エラー - ユーザーID（ERR-002）**
   - 問題: デモモード時に`currentUserId`が空文字列になり外部キー制約違反
   - 原因: 認証が無効化されているため`authUser?.id`が空
   - 対応: `effectiveUserId = currentUserId || users[0]?.id || ""`でフォールバック実装

3. **案件登録エラー - descriptionカラム（ERR-003）**
   - 問題: `deals`テーブルに`description`カラムが存在しないのにINSERTしようとして400エラー
   - 原因: コードとデータベーススキーマの不整合
   - 対応: `deal-form.tsx`から`description`フィールドを完全に削除

4. **ビルドエラー - cmdkパッケージ**
   - 問題: `npm run build`で`cmdk`モジュールが見つからないエラー
   - 対応: `npm install cmdk`でパッケージを追加

### 作業3: RLSポリシー設定

1. **SQLスクリプト提供**
   - 全テーブルに対してALLOW ALLポリシーを設定するSQL
   - 対象テーブル: deals, contracts, customers, tasks, payments, activities, contract_status_history

---

## 作業履歴（2025/12/19）

### 作業1: ブランチマージとデプロイ

1. **ブランチマージ**
   - `origin/claude/version-1-initial-setup-o44OO` → `main` へのマージを実施
   - マージコミット: `eacc79e` (feat: 一覧画面のUX大幅改善)
   - 変更ファイル: 8ファイル（+1,603行/-275行）

2. **発生した問題と対応**
   - **問題1**: 初回確認時にリモートの最新コミットを見逃した
     - **原因**: `git fetch`を実行せずにローカルブランチのログを確認したため
     - **対応**: `git fetch origin`を実行してリモート最新情報を取得
   - **問題2**: ローカルに未コミットの変更があり、マージが中断された
     - **対応**: ユーザー確認の上、`git checkout -- . && git clean -fd`でローカル変更を破棄
   - **問題3**: GitHubへのpush後、Vercelの自動デプロイが開始されなかった
     - **原因（推測）**: Fast-forwardマージのため、新規コミット作成なしにHEADが移動。Webhookが既存コミットとして認識しスキップ
     - **対応**: `vercel --prod`コマンドで手動デプロイを実行し、正常にデプロイ完了

3. **デプロイ結果**
   - Production URL: https://sales-ms.vercel.app
   - デプロイ時刻: 2025/12/19 16:35頃
   - ステータス: Ready

### 作業2: 検索UX改善

1. **実装内容**
   - Salesforce/HubSpotのベストプラクティスを調査
   - Phase 1として以下を実装:
     - クイックフィルタチップ（インライン表示）
     - 日付範囲プリセット（今日、今週、今月など）
     - ソートインジケータUI改善
     - 検索結果件数表示改善

2. **変更ファイル**
   - `src/components/ui/search-filter-bar.tsx` - コアコンポーネント拡張
   - `src/components/features/deals/deal-list.tsx` - クイックフィルタ有効化
   - `src/components/features/tasks/task-list.tsx` - クイックフィルタ有効化

3. **デプロイ結果**
   - コミット: `ea14d62` (feat: 検索UX大幅改善)
   - Production URL: https://sales-ms.vercel.app
   - デプロイ時刻: 2025/12/19 17:00頃
   - ステータス: Ready
